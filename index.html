<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />

<script src="html5.js"></script><!-- this is the javascript allowing html5 to run in older browsers -->

<title>Myfavouritesandwich - An Unhosted demo</title>
<link rel="stylesheet" href="css/uncompressed/reset.css" />
<link rel="stylesheet" href="css/uncompressed/text.css" />
<link rel="stylesheet" href="general.css" />
<link rel="stylesheet" href="css/uncompressed/layout.css" />

<script>
//DECIDE WHETHER LOGGED IN:
function processToken() {
	if(localStorage.getItem('token') === null) {
		document.getElementById('loginScreen').style.display='block';
		document.getElementById('loggedIn').style.display='none';
	} else {
		document.getElementById('loginScreen').style.display='none';
		document.getElementById('loggedIn').style.display='block';
		retrieveFavSandwich();
	}
}

//LOGGED IN:
function retrieveFavSandwich() { 
	document.getElementById('loggedInUser').innerHTML=
		'<span>Logged in as <strong>'
		+localStorage.getItem('user_name')
		+'</strong> [<a onclick="localStorage.removeItem(\'token\');processToken();">Logout</a>]</span>';
	var req = new XMLHttpRequest();
	req.onreadystatechange=function()
          {
          if (req.readyState==4 && req.status==200)
            {
            processFavSandwich(req.responseText);
            }
          }
	req.open("GET", "http://"+localStorage.getItem("dav")+"/favSandwich.json", true);
	req.setRequestHeader("Authorization", "Basic "+localStorage.getItem("token"));
	req.withCredentials = "true";
	req.send();
}
function processFavSandwich(text) {
	var sandwich = JSON.parse(text);
	document.getElementById('showFirstIngredient').innerHTML = sandwich.ingredients[0];
	document.getElementById('showSecondIngredient').innerHTML = sandwich.ingredients[1];
	document.getElementById('firstIngredient').value = sandwich.ingredients[0];
	document.getElementById('secondIngredient').value = sandwich.ingredients[1];
}
function saveFavSandwich(ingredients) {
	var text = JSON.stringify({"ingredients":ingredients});
	var req = new XMLHttpRequest();
	req.onreadystatechange=function()
          {
          if (req.readyState==4 && req.status==200)
            {
            processFavSandwich(req.responseText);
            }
          }
	req.open("PUT", "http://"+localStorage.getItem("dav")+"/favSandwich.json", true);
	req.setRequestHeader("Authorization", "Basic "+localStorage.getItem("token"));
	req.withCredentials = "true";
	req.send(text);
	retrieveFavSandwich();//do full round-trip to make sure browser and unhosted storage node are always in sync
}
</script>
</head>
<body onload="processToken();">
<div class="preload"></div>
<div class="preload2"></div>
<div id="preheader"></div>
<div id="plateContainer">
	<figure id="plate"></figure>
</div>

<div id="mainWrap">



	<div id="loginScreen">



				<header>
			<h1>My Favourite Sandwich</h1>
			<p>Login with my unhosted account</p>
			<input id="user" name="unhostedacct" onfocus="if(this.value=='user@provider.org'){this.className='formfocus'; this.value=''}" onblur="if(!this.value){this.className='formblur'; this.value='user@provider.org'}" type="text" value="user@provider.org"/>
			<input class="submit" name="submit" type="submit" value="Submit!" onclick="localStorage.setItem('user_name', document.getElementById('user').value); window.open('./popup.html', 'Auth2-cs', 'width=500, height=500');">
		</header>
			
		<div id="register">
			<p><strong>Don't have an unhosted account? </strong> Register here:</p>
			<input id="provider" name="unhostedacct" type="text" value="redlibre.org"/>
			<input class="submit" name="submit" type="submit" value="Create account" onclick="window.open('http://'+document.getElementById('provider').value+'/register.html', 'Register', 'width=500, height=500');">
		</div>




	</div>
	<div id="loggedIn" class="hidden">



		<div id="preheader">
			<span>
				<span id="loggedInUser"></span>
			</span>
			<div id="plateContainer">
				<figure id="plate"></figure>
			</div>
			
				
			
		</div>
			
		<header class="data">
			<p>My favourite sandwich has <strong><span id="showFirstIngredient"></span></strong> and 
				<strong><span id="showSecondIngredient"></span></strong> on it</p>
			<input id="firstIngredient" name="firstIngredient" onfocus="if(this.value=='1st ingredient'){this.className='formfocus'; this.value=''}" onblur="if(!this.value){this.className='formblur'; this.value='1st ingredient'}" type="text" value="1st ingredient"/>
			<input id="secondIngredient" name="secondIngredient" onfocus="if(this.value=='2nd ingredient'){this.className='formfocus'; this.value=''}" onblur="if(!this.value){this.className='formblur'; this.value='2nd ingredient'}" type="text" value="2nd ingredient"/>
					
			<input class="submitingredients" name="submit" type="submit" value="Submit!" onclick="saveFavSandwich(
							[document.getElementById('firstIngredient').value,
							document.getElementById('secondIngredient').value]);"/>
		</header>			



	</div>




	<div id="footerSpacer"></div>					
	<footer>
		<div class="wrapper">
		<div id="leftcolumn">
			<h3>So... what is this all about?</h3>
			<p>
				This is a fictional site that demonstrates the unhosted architecture, a tutorial, so you can take a look at the code to understand how unhosted web apps work. View the application source code <a href="http://github.com/michiel-unhosted/myfavouritesandwich/blob/master/index.html" target="_blank">here</a>. The popup that handles the <a href="http://webfinger.org" target="_blank">WebFinger</a> is <a href="http://github.com/michiel-unhosted/myfavouritesandwich/blob/master/popup.html" target="_blank">here</a>, and  <a href="http://github.com/michiel-unhosted/myfavouritesandwich/blob/master/cb.html" target="_blank">here</a> is the <a href="http://code.google.com/apis/accounts/docs/OAuth2.html#CS" target="_blank">OAuth2-cs</a> callback.
			</p>
			<p>
				<strong>myfavouritesandwich.org is not a commercial website, nor is it affiliated with any trademark</strong>
			</p>
		</div>
		<figure id="island"></figure>
		<div id="rightcolumn">
			<h3>What is Unhosted?</h3>
			<p>
				<strong>Unhosted is a project for strengthening free software against hosted software. 
				</strong>
				An unhosted web app is only source code. Dynamic data is encrypted and decentralised, to per-user storage nodes. This benefits <strong>free software</strong>, as well as <strong>scalability</strong>, <strong>robustness</strong>, and <strong>online privacy</strong>.
			</p>
			<p>
				<strong>Check it out at <a href="http://www.unhosted.org">http://www.unhosted.org/</a></strong>
			</p>
		</div>
		<div class="clear">
		</div>				
	</footer>
</div>
</body>
</html>
